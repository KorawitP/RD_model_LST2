# --- ‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏ô‡πÇ‡∏°‡πÄ‡∏î‡∏• Random Forest (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ Overfitting üõ°Ô∏è) ---
import joblib
import pandas as pd
import numpy as np
from sklearn.model_selection import train_test_split, cross_val_score
from sklearn.impute import SimpleImputer
from sklearn.ensemble import RandomForestRegressor
from sklearn.metrics import mean_squared_error, r2_score
import time
import gc

# ==============================================================================
# üìù ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà (Concept):
# ‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ "‡∏â‡∏•‡∏≤‡∏î‡∏Å‡∏ß‡πà‡∏≤" ‡πÑ‡∏ü‡∏•‡πå fast.py ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏±‡∏ô‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£ "‡∏à‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö" (Overfitting)
#
# Overfitting ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?
# ‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà AI ‡∏ó‡πà‡∏≠‡∏á‡∏à‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏°‡∏≤‡πÄ‡∏õ‡πä‡∏∞‡πÜ ‡∏à‡∏ô‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏°‡∏≤‡∏Å (R¬≤ ‡∏™‡∏π‡∏á‡∏õ‡∏£‡∏µ‡πä‡∏î)
# ‡πÅ‡∏ï‡πà‡∏û‡∏≠‡πÄ‡∏à‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà (Test Set) ‡∏Å‡∏•‡∏±‡∏ö‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ú‡∏¥‡∏î‡πÄ‡∏¢‡∏≠‡∏∞ (R¬≤ ‡∏ï‡∏Å‡∏Æ‡∏ß‡∏ö)
#
# ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ:
# ‡πÄ‡∏£‡∏≤‡∏à‡∏∞ "‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ" ‡∏Ç‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (Pruning)
# ‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô 25 ‡∏ä‡∏±‡πâ‡∏ô, ‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏ï‡∏Å‡∏Å‡∏¥‡πà‡∏á‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
# ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ AI ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à "‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°" ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡πà‡∏≠‡∏á‡∏à‡∏≥‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢
# ==============================================================================

print("="*60)
print("=== ‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏ô‡πÇ‡∏°‡πÄ‡∏î‡∏• Random Forest (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ Overfitting) ===")
print("="*60)

# ------------------------------------------------------------------------------
# 1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
# ------------------------------------------------------------------------------
print("\n[1/7] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...")
start_time = time.time()
df = pd.read_parquet('data/df_final_processed.parquet')
print(f"‚úì ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: {len(df):,} ‡πÅ‡∏ñ‡∏ß ({time.time()-start_time:.2f} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)")

# ------------------------------------------------------------------------------
# 2. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° features ‡πÅ‡∏•‡∏∞ target
# ------------------------------------------------------------------------------
print("\n[2/7] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...")
features = ['CH4', 'NO2', 'CO', 'LULC', 'DEM', 'NDVI', 'Albedo', 'Solar_Radiation', 'month', 'year']
target = 'LST'

X_raw = df[features].copy()
y = df[target].copy()
del df
gc.collect()

print(f"‚úì Features: {len(features)} ‡∏ï‡∏±‡∏ß")
print(f"‚úì Target: {target}")

# ------------------------------------------------------------------------------
# 3. ‡∏ó‡∏≥ Imputation (‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ)
# ------------------------------------------------------------------------------
print("\n[3/7] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ (Imputation)...")
start_time = time.time()
imputer = SimpleImputer(strategy='mean')
X = imputer.fit_transform(X_raw)
del X_raw
gc.collect()
print(f"‚úì ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ({time.time()-start_time:.2f} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)")

# ------------------------------------------------------------------------------
# 4. ‡πÅ‡∏ö‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Train/Test Split)
# ------------------------------------------------------------------------------
print("\n[4/7] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏ö‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Train/Test...")
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.3, random_state=42)
del X, y
gc.collect()
print(f"‚úì ‡πÅ‡∏ö‡πà‡∏á Train: {len(X_train):,}, Test: {len(X_test):,}")

# ------------------------------------------------------------------------------
# 5. ‡πÄ‡∏ó‡∏£‡∏ô‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏Ñ‡πà‡∏≤ (Hyperparameter Tuning Breakdown)
# ------------------------------------------------------------------------------
print("\n[5/7] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ó‡∏£‡∏ô‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏î‡πâ‡∏ß‡∏¢‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏©...")
print("üõ°Ô∏è ‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö (Overfitting Prevention):")
print("   1. max_depth=25         -> ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô 25 ‡∏ä‡∏±‡πâ‡∏ô (‡∏Å‡∏±‡∏ô‡∏à‡∏≥‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ñ‡∏¢‡∏¥‡∏ö‡∏¢‡πà‡∏≠‡∏¢)")
print("   2. min_samples_split=20 -> ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏Å‡∏¥‡πà‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 20 ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ï‡∏Å‡∏Å‡∏¥‡πà‡∏á‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß (‡∏û‡∏≠‡πÅ‡∏Ñ‡πà‡∏ô‡∏±‡πâ‡∏ô)")
print("   3. min_samples_leaf=10  -> ‡∏õ‡∏•‡∏≤‡∏¢‡∏Å‡∏¥‡πà‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 10 ‡∏ï‡∏±‡∏ß (‡∏´‡πâ‡∏≤‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏¥‡πà‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)")
print("   4. max_features='sqrt'  -> ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÅ‡∏Ñ‡πà‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô (‡∏™‡∏∏‡πà‡∏°‡∏£‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£)")
print("\n...‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• (‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡∏ô‡∏≤‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢)...")

start_time = time.time()

model = RandomForestRegressor(
    # üå≤ 1. ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ (Number of Trees)
    # ‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ 100 ‡∏ï‡πâ‡∏ô ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß
    n_estimators=100,         
    
    # üìè 2. ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∂‡∏Å (Max Depth) - ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ Overfitting!
    # ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏¥‡∏ô 25 ‡∏Ç‡πâ‡∏≠ (‡∏ä‡∏±‡πâ‡∏ô) 
    # ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏´‡πâ‡∏≤‡∏°‡∏à‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡πÉ‡∏´‡πâ‡∏à‡∏≥‡πÅ‡∏Ñ‡πà‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏ç‡πà‡πÜ
    max_depth=25,             
    
    # ‚úÇÔ∏è 3. ‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡∏Å‡∏Å‡∏¥‡πà‡∏á (Min Samples Split)
    # ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏Å‡∏≠‡∏á‡∏ô‡∏±‡πâ‡∏ô‡∏°‡∏µ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 20 ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á "‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏ö‡πà‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏¢‡πà‡∏≠‡∏¢‡∏ï‡πà‡∏≠"
    # ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏é‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏Ñ‡πà‡πÑ‡∏°‡πà‡∏Å‡∏µ‡πà‡∏ï‡∏±‡∏ß (‡∏ã‡∏∂‡πà‡∏á‡∏°‡∏±‡∏Å‡πÄ‡∏õ‡πá‡∏ô Noise)
    min_samples_split=20,     
    
    # üçÉ 4. ‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ (Min Samples Leaf)
    # ‡∏õ‡∏•‡∏≤‡∏¢‡∏Å‡∏¥‡πà‡∏á (Leaf) ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 10 ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
    # ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏Å‡∏é‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏ç‡πà ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÅ‡∏Ñ‡πà‡∏ü‡∏•‡∏∏‡πä‡∏Ñ‡πÄ‡∏à‡∏≠‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    min_samples_leaf=10,      
    
    # üé≤ 5. ‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ (Max Features)
    # 'sqrt' = ‡∏™‡πÅ‡∏Ñ‡∏ß‡∏£‡πå‡∏£‡∏π‡∏ó (‡πÄ‡∏ä‡πà‡∏ô‡∏°‡∏µ 10 ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ ‡∏à‡∏∞‡∏™‡∏∏‡πà‡∏°‡∏°‡∏≤‡∏î‡∏π‡πÅ‡∏Ñ‡πà 3 ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏¥‡πà‡∏á)
    # ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡πâ‡∏ô "‡∏°‡∏≠‡∏á‡∏ï‡πà‡∏≤‡∏á‡∏°‡∏∏‡∏°" ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≠‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡∏´‡∏°‡∏î (‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô)
    max_features='sqrt',      
    
    n_jobs=-1,                # ‡πÉ‡∏ä‡πâ CPU ‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏¥‡∏Å‡∏±‡∏î
    random_state=42,          # ‡∏•‡πá‡∏≠‡∏Å‡∏ú‡∏•‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
    verbose=1
)

model.fit(X_train, y_train)
training_time = time.time() - start_time

print(f"\n‚úì ‡πÄ‡∏ó‡∏£‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤: {training_time/60:.2f} ‡∏ô‡∏≤‡∏ó‡∏µ")

# ------------------------------------------------------------------------------
# 6. Cross-Validation (‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö)
# ------------------------------------------------------------------------------
print("\n[6/7] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥ Cross-Validation (5-Fold)...")
# Concept: ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÅ‡∏ö‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Train ‡πÄ‡∏õ‡πá‡∏ô 5 ‡∏™‡πà‡∏ß‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏ô‡∏Å‡∏±‡∏ô‡∏™‡∏≠‡∏ö 5 ‡∏£‡∏≠‡∏ö
# ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 1: ‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏ß‡∏ô 1-4 ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô, ‡∏™‡∏≠‡∏ö‡∏™‡πà‡∏ß‡∏ô 5
# ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 2: ‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏ß‡∏ô 1,2,3,5 ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô, ‡∏™‡∏≠‡∏ö‡∏™‡πà‡∏ß‡∏ô 4
# ... ‡∏ó‡∏≥‡∏à‡∏ô‡∏Ñ‡∏£‡∏ö
# ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà "‡∏ô‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î" ‡∏ß‡πà‡∏≤‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÄ‡∏Å‡πà‡∏á‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏´‡∏° (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ü‡∏•‡∏∏‡πä‡∏Ñ)
print("‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà... (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏ô‡∏™‡∏≠‡∏ö 5 ‡∏£‡∏≠‡∏ö)")
cv_scores = cross_val_score(model, X_train, y_train, cv=5, 
                            scoring='r2', n_jobs=-1, verbose=0)
print(f"‚úì ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏î‡∏¥‡∏ö 5 ‡∏£‡∏≠‡∏ö: {cv_scores}")
print(f"‚úì ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (Mean R¬≤): {cv_scores.mean():.4f}")

# ------------------------------------------------------------------------------
# 7. ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏• (Evaluation & Gap Analysis)
# ------------------------------------------------------------------------------
print("\n[7/7] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ Overfitting...")
y_pred_train = model.predict(X_train)
y_pred_test = model.predict(X_test)

r2_train = r2_score(y_train, y_pred_train)
r2_test = r2_score(y_test, y_pred_test)
rmse_test = np.sqrt(mean_squared_error(y_test, y_pred_test))

print("\n" + "="*60)
print("=== üìä ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÇ‡∏°‡πÄ‡∏î‡∏• ===")
print("="*60)
print(f"Train R¬≤: {r2_train:.4f} (‡∏ú‡∏•‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)")
print(f"Test  R¬≤: {r2_test:.4f} (‡∏ú‡∏•‡∏™‡∏≠‡∏ö‡∏à‡∏£‡∏¥‡∏á)")
print(f"Test RMSE: {rmse_test:.4f} ‡∏≠‡∏á‡∏®‡∏≤")

# ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á (Gap)
gap = r2_train - r2_test
print(f"\nüìâ Overfitting Gap (‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô): {gap:.4f}")
# ‡∏ñ‡πâ‡∏≤ Gap ‡∏ô‡πâ‡∏≠‡∏¢ ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤ ‡∏ú‡∏•‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏±‡∏ö‡∏™‡∏≠‡∏ö‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏Å‡∏±‡∏ô (‡∏î‡∏µ‡∏°‡∏≤‡∏Å)
if gap < 0.1:
    print(f"  ‚úÖ ‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡πà‡∏≠‡∏¢‡∏à‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö (Overfitting ‡∏ô‡πâ‡∏≠‡∏¢)")
elif gap < 0.2:
    print(f"  ‚ö†Ô∏è ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á - ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ö‡πâ‡∏≤‡∏á")
else:
    print(f"  ‚ùå ‡πÅ‡∏¢‡πà - ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏à‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏°‡∏≤‡∏ï‡∏≠‡∏ö (Overfitting ‡∏™‡∏π‡∏á)")
print("="*60)

# ------------------------------------------------------------------------------
# 8. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•
# ------------------------------------------------------------------------------
print("\n[8/8] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•...")
model_path = 'models/random_forest_model_optimized.joblib'
joblib.dump(model, model_path)
print(f"‚úì ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡πà: {model_path}")

# ‡πÅ‡∏™‡∏î‡∏á Feature Importance
print("\n=== ‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (Top 10) ===")
feature_importance = pd.DataFrame({
    'Feature': features,
    'Importance': model.feature_importances_
}).sort_values('Importance', ascending=False)
print(feature_importance.to_string(index=False))

print("\n" + "="*60)
print("=== ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î! ===")
print("="*60)
print("\nüí° ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á:")
print("‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ô‡∏µ‡πâ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Train ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ fast.py (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏±‡∏ô‡∏à‡∏≥)")
print("‡πÅ‡∏ï‡πà‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Test (‡∏™‡∏≠‡∏ö‡∏à‡∏£‡∏¥‡∏á) ‡∏Ñ‡∏ß‡∏£‡∏à‡∏∞‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏Å‡∏±‡∏ô ‡πÅ‡∏•‡∏∞ Gap ‡∏Ñ‡∏ß‡∏£‡∏à‡∏∞‡∏•‡∏î‡∏•‡∏á")
print("‡∏ã‡∏∂‡πà‡∏á‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ô‡∏µ‡πâ '‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£' ‡∏Å‡∏ß‡πà‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á")
