# --- ‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏ô‡πÇ‡∏°‡πÄ‡∏î‡∏• Random Forest (‡∏â‡∏ö‡∏±‡∏ö‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢: Final Version üåü) ---
import joblib
import pandas as pd
import numpy as np
from sklearn.model_selection import train_test_split, cross_val_score
from sklearn.impute import SimpleImputer
from sklearn.ensemble import RandomForestRegressor
from sklearn.metrics import mean_squared_error, r2_score
import time
import gc

# ==============================================================================
# üìù ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà (Concept):
# ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà "‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î" ‡∏Ç‡∏≠‡∏á Random Forest ‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏ô‡∏µ‡πâ
#
# ‡∏à‡∏∏‡∏î‡πÄ‡∏î‡πà‡∏ô:
# 1. ‡∏ï‡∏±‡∏î‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÑ‡∏£‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå (Feature Selection): ‡πÄ‡∏£‡∏≤‡∏ï‡∏±‡∏î LULC ‡πÅ‡∏•‡∏∞ DEM ‡∏≠‡∏≠‡∏Å
#    ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏û‡∏ö‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 2 ‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ "‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏•‡∏¢" (Zero Variance)
#    ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠‡∏ï‡∏≠‡∏ö ‡∏Å.‡πÑ‡∏Å‡πà ‡∏´‡∏°‡∏î... ‡∏°‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏¢‡∏Å‡πÅ‡∏¢‡∏∞‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡∏¢ ‡∏ï‡∏±‡∏î‡∏ó‡∏¥‡πâ‡∏á‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤
# 2. ‡∏õ‡∏£‡∏±‡∏ö‡∏à‡∏π‡∏ô‡πÅ‡∏•‡πâ‡∏ß (Tuned): ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å optimized.py
# 3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≠‡∏ö‡∏î‡πâ‡∏≤‡∏ô (Cross-Validation): ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ú‡∏•‡∏™‡∏≠‡∏ö 5 ‡∏£‡∏≠‡∏ö ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå
# ==============================================================================

print("="*70)
print("=== ‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏ô‡πÇ‡∏°‡πÄ‡∏î‡∏• Random Forest (‡∏â‡∏ö‡∏±‡∏ö Final) ===")
print("=== ‡∏ï‡∏±‡∏î‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ LULC ‡πÅ‡∏•‡∏∞ DEM ‡∏≠‡∏≠‡∏Å (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô) ===")
print("="*70)

# ------------------------------------------------------------------------------
# 1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
# ------------------------------------------------------------------------------
print("\n[1/7] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•... (Reading Data)")
start_time = time.time()
df = pd.read_parquet('data/df_final_processed.parquet')
print(f"‚úì ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: {len(df):,} ‡πÅ‡∏ñ‡∏ß ({time.time()-start_time:.2f} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)")

# ------------------------------------------------------------------------------
# 2. ‡∏Ñ‡∏±‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ (Feature Selection) - ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç!
# ------------------------------------------------------------------------------
print("\n[2/7] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏±‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ (Feature Selection)...")

# ‡πÄ‡∏£‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏ú‡∏•‡∏à‡∏£‡∏¥‡∏á
features = ['CH4', 'NO2', 'CO', 'NDVI', 'Albedo', 'Solar_Radiation', 'month', 'year']
target = 'LST'

print(f"‚ÑπÔ∏è  ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏î LULC ‡πÅ‡∏•‡∏∞ DEM ‡∏≠‡∏≠‡∏Å:")
print(f"    - ‡∏û‡∏ö‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• LULC (‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô) ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡∏´‡∏°‡∏î (Variance = 0)")
print(f"    - ‡∏û‡∏ö‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• DEM (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà) ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡∏´‡∏°‡∏î (Variance = 0)")
print(f"    - ‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡πÇ‡∏°‡πÄ‡∏î‡∏• ‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏£‡∏Å‡πÅ‡∏•‡∏∞‡∏ä‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÜ")

print(f"\n‚úì Features ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏à‡∏£‡∏¥‡∏á: {len(features)} ‡∏ï‡∏±‡∏ß -> {features}")
print(f"‚úì Target: {target}")

X_raw = df[features].copy()
y = df[target].copy()
del df
gc.collect()

# ------------------------------------------------------------------------------
# 3. Imputation (‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ)
# ------------------------------------------------------------------------------
print("\n[3/7] ‡∏Å‡∏≥‡∏•‡∏±‡∏á Imputation (‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢)...")
start_time = time.time()
imputer = SimpleImputer(strategy='mean')
X = imputer.fit_transform(X_raw)
del X_raw
gc.collect()
print(f"‚úì ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ({time.time()-start_time:.2f} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)")

# ------------------------------------------------------------------------------
# 4. ‡πÅ‡∏ö‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Train/Test Split)
# ------------------------------------------------------------------------------
print("\n[4/7] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏ö‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (70% Train, 30% Test)...")
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.3, random_state=42)
del X, y
gc.collect()
print(f"‚úì Train set: {len(X_train):,} ‡πÅ‡∏ñ‡∏ß")
print(f"‚úì Test set: {len(X_test):,} ‡πÅ‡∏ñ‡∏ß")

# ------------------------------------------------------------------------------
# 5. ‡πÄ‡∏ó‡∏£‡∏ô‡πÇ‡∏°‡πÄ‡∏î‡∏• (Training)
# ------------------------------------------------------------------------------
print("\n[5/7] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ó‡∏£‡∏ô‡πÇ‡∏°‡πÄ‡∏î‡∏• (‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ)...")
print("‚ö° ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (Best Settings):")
print("   - max_depth=25 (‡∏û‡∏≠‡∏î‡∏µ ‡πÑ‡∏°‡πà‡∏•‡∏∂‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô)")
print("   - min_samples_leaf=10 (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß‡πÜ)")
print("\n...‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...")

start_time = time.time()

model = RandomForestRegressor(
    # --- ‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏°‡πÄ‡∏î‡∏• (Structural Parameters) ---
    n_estimators=100,         # üå≤ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ 100 ‡∏ï‡πâ‡∏ô (‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô)
    
    # --- ‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö (Regularization Parameters) ---
    # ‡πÄ‡∏£‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå 'train_model_optimized.py' ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡πà‡∏≤‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
    max_depth=25,             # üìè ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∂‡∏Å‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 25 ‡∏ä‡∏±‡πâ‡∏ô (‡πÑ‡∏°‡πà‡∏•‡∏∂‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ)
    min_samples_split=20,     # ‚úÇÔ∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 20 ‡∏ï‡∏±‡∏ß‡∏ñ‡∏∂‡∏á‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡∏Å‡∏Å‡∏¥‡πà‡∏á
    min_samples_leaf=10,      # üçÉ ‡∏õ‡∏•‡∏≤‡∏¢‡∏Å‡∏¥‡πà‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 10 ‡∏ï‡∏±‡∏ß
    max_features='sqrt',      # üé≤ ‡∏™‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏°‡∏≤‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÅ‡∏Ñ‡πà‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô (Square Root)
    
    # --- ‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (Execution Parameters) ---
    n_jobs=-1,                # ‚ö° ‡πÉ‡∏ä‡πâ CPU ‡∏ó‡∏∏‡∏Å Core (‡∏ß‡∏¥‡πà‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏™‡∏õ‡∏µ‡∏î)
    random_state=42,          # üîí ‡∏•‡πá‡∏≠‡∏Å‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÉ‡∏´‡πâ‡∏Ñ‡∏á‡∏ó‡∏µ‡πà
    verbose=1                 # üì¢ ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
)

model.fit(X_train, y_train)
training_time = time.time() - start_time

print(f"\n‚úì ‡πÄ‡∏ó‡∏£‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤: {training_time/60:.2f} ‡∏ô‡∏≤‡∏ó‡∏µ")

# ------------------------------------------------------------------------------
# 6. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ 5 ‡∏£‡∏≠‡∏ö (Cross-Validation)
# ------------------------------------------------------------------------------
print("\n[6/7] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ 5 ‡∏£‡∏≠‡∏ö (Cross-Validation)...")
cv_scores = cross_val_score(model, X_train, y_train, cv=5, 
                            scoring='r2', n_jobs=-1, verbose=0)

print(f"‚úì ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 5 ‡∏£‡∏≠‡∏ö: {cv_scores}")
# ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ö‡∏µ‡πà‡∏¢‡∏á‡πÄ‡∏ö‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô (Mean +/- 2*Std) ‡∏à‡∏∞‡∏ö‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
print(f"‚úì ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (Mean R¬≤): {cv_scores.mean():.4f} (+/- {cv_scores.std() * 2:.4f})")

# ------------------------------------------------------------------------------
# 7. ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ (Evaluation)
# ------------------------------------------------------------------------------
print("\n[7/7] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•‡∏£‡∏≠‡∏ö‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢...")
y_pred_train = model.predict(X_train)
y_pred_test = model.predict(X_test)

r2_train = r2_score(y_train, y_pred_train)
rmse_train = np.sqrt(mean_squared_error(y_train, y_pred_train))

r2_test = r2_score(y_test, y_pred_test)
rmse_test = np.sqrt(mean_squared_error(y_test, y_pred_test))

print("\n" + "="*70)
print("=== üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô (Final Report) ===")
print("="*70)
print(f"1. ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ (R¬≤ Accuracy):")
print(f"   - ‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Train): {r2_train:.4f}")
print(f"   - ‡∏™‡∏≠‡∏ö‡∏à‡∏£‡∏¥‡∏á (Test):     {r2_test:.4f}  <-- ‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î!")
print(f"\n2. ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô (RMSE Error):")
print(f"   - ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: +/- {rmse_test:.4f} ‡∏≠‡∏á‡∏®‡∏≤‡πÄ‡∏ã‡∏•‡πÄ‡∏ã‡∏µ‡∏¢‡∏™")
print(f"\n3. ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Overfitting (Gap Analysis):")
gap = r2_train - r2_test
print(f"   - ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á (Gap): {gap:.4f}")

if gap < 0.1:
    print(f"   ‚úÖ ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å! Gap ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 0.1 ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÄ‡∏Å‡πà‡∏á‡∏à‡∏£‡∏¥‡∏á ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡πà‡∏≠‡∏á‡∏à‡∏≥")
elif gap < 0.2:
    print(f"   ‚ö†Ô∏è ‡∏û‡∏≠‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ - ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ Gap ‡∏ö‡πâ‡∏≤‡∏á‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ")
else:
    print(f"   ‚ùå ‡∏£‡∏∞‡∏ß‡∏±‡∏á - Gap ‡πÄ‡∏¢‡∏≠‡∏∞‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏≠‡∏≤‡∏à‡∏à‡∏∞ Overfitting")

# ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡πÄ‡∏î‡∏¥‡∏°
print("-" * 30)
print("üí° ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÅ‡∏ö‡∏ö‡πÄ‡∏Å‡πà‡∏≤ (‡∏ó‡∏µ‡πà‡∏°‡∏µ LULC/DEM):")
print("   - ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÄ‡∏Å‡πà‡∏≤ Test R¬≤ ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì: 0.7111")
print(f"   - ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ô‡∏µ‡πâ Test R¬≤ ‡πÄ‡∏õ‡πá‡∏ô:    {r2_test:.4f}")

if r2_test >= 0.7111:
    print("\n‚úÖ ‡∏™‡∏£‡∏∏‡∏õ: ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î LULC/DEM ‡∏≠‡∏≠‡∏Å ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ú‡∏•‡πÅ‡∏¢‡πà‡∏•‡∏á (‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏≤‡∏à‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô)")
    print("   ‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢!")
else:
    diff = 0.7111 - r2_test
    print(f"\n‚ÑπÔ∏è ‡∏™‡∏£‡∏∏‡∏õ: ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡∏î‡∏•‡∏á‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢ ({diff:.4f}) ‡πÅ‡∏•‡∏Å‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß")
    
print("="*70)

# ------------------------------------------------------------------------------
# 8. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏• (Save)
# ------------------------------------------------------------------------------
print("\n[8/8] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏• final...")
model_path = 'models/random_forest_model_final.joblib'
joblib.dump(model, model_path)
print(f"‚úì ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡πà: {model_path}")

# ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£
print("\n=== üèÜ ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ (Feature Importance) ===")
feature_importance = pd.DataFrame({
    'Feature': features,
    'Importance': model.feature_importances_
}).sort_values('Importance', ascending=False)
print(feature_importance.to_string(index=False))

print("\n" + "="*70)
print("=== üéâ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î! ===")
print("="*70)
